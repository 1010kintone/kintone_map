<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨ç´™åœ¨åº«ãƒãƒƒãƒ— - Smart Stock Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .map-container { 
            position: relative; 
            width: 100%; 
            overflow: hidden; 
            border-radius: 0.5rem; 
            background: #2d3748; 
            touch-action: pan-x pan-y; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ“ä½œã‚’è¨±å¯ */
        }
        
        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .grid-overlay {
            display: grid;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* é€šå¸¸ã¯ã‚¯ãƒªãƒƒã‚¯ã‚’é€é */
        }

        /* å€‹åˆ¥ã®ã‚»ãƒ« */
        .grid-cell {
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
            pointer-events: all; /* ã‚»ãƒ«è‡ªä½“ã¯ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ */
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        body.edit-mode .grid-cell {
            border: 1px dashed rgba(255, 255, 0, 0.3);
            background: rgba(0, 0, 0, 0.2);
        }
        body.edit-mode .grid-cell:hover {
            background: rgba(255, 255, 0, 0.2);
        }

        /* ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆæ¤œç´¢ãƒ’ãƒƒãƒˆæ™‚ï¼‰ */
        .grid-cell.active {
            background: rgba(239, 68, 68, 0.6) !important; /* text-red-500 */
            border: 2px solid #ef4444 !important;
            box-shadow: 0 0 15px #ef4444;
            z-index: 20;
            animation: pulse 1.5s infinite;
        }

        /* ãƒãƒƒãƒ”ãƒ³ã‚°æ¸ˆã¿ã‚»ãƒ«ã®è¡¨ç¤º */
        .grid-cell.mapped {
            background: rgba(59, 130, 246, 0.1); /* è–„ã„é’ */
        }
        .grid-cell.mapped::after {
            content: attr(data-address);
            position: absolute;
            top: 2px; left: 2px;
            font-size: 8px;
            color: rgba(255,255,255,0.7);
            background: rgba(0,0,0,0.5);
            padding: 1px 3px;
            border-radius: 2px;
            pointer-events: none;
        }

        /* æ®µæ•°è¡¨ç¤ºãªã©ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ */
        .info-bubble {
            position: absolute;
            bottom: 110%; left: 50%; transform: translateX(-50%);
            background: #1f2937; color: white; padding: 4px 8px;
            border-radius: 6px; font-weight: bold; font-size: 12px;
            white-space: nowrap; pointer-events: none; 
            opacity: 0; transition: opacity 0.3s;
            z-index: 30;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .info-bubble::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #1f2937 transparent transparent transparent;
        }
        .active .info-bubble { opacity: 1; bottom: 120%; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex flex-col overflow-hidden">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-blue-900 text-white p-4 shadow-lg flex justify-between items-center shrink-0 z-10">
        <div class="flex items-center gap-2">
            <span class="material-icons text-blue-300">inventory_2</span>
            <div>
                <h1 class="text-lg font-bold leading-tight">ç”¨ç´™åœ¨åº«ãƒãƒƒãƒ—</h1>
                <p class="text-xs text-blue-200">DX Stock Finder</p>
            </div>
        </div>
        <div id="target-display" class="text-xl font-mono font-bold text-yellow-300"></div>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½) -->
    <main class="flex-1 overflow-auto p-4 space-y-4">
        
        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- ã‚¹ã‚­ãƒ£ãƒ³ãƒ»æ¤œç´¢ -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex gap-2 mb-3">
                    <input id="search-input" type="text" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-lg uppercase focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ç•ªåœ° (ä¾‹: A-1-2)">
                    <button id="search-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-lg font-bold flex items-center">
                        <span class="material-icons">search</span>
                    </button>
                    <button id="scan-trigger" class="bg-gray-800 hover:bg-gray-900 text-white px-4 rounded-lg font-bold flex items-center gap-1">
                        <span class="material-icons">qr_code_scanner</span>
                        <span class="hidden sm:inline">èª­å–</span>
                    </button>
                </div>
                
                <div id="reader-container" class="hidden transition-all duration-300">
                    <div id="reader" class="rounded-lg overflow-hidden border-2 border-gray-300"></div>
                    <button onclick="stopScanner()" class="w-full mt-2 py-2 text-sm text-red-500 font-bold hover:bg-red-50 rounded">ã‚«ãƒ¡ãƒ©ã‚’é–‰ã˜ã‚‹</button>
                </div>

                <!-- æ¤œç´¢çµæœã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div id="result-action" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg flex justify-between items-center animate-pulse">
                    <div>
                        <p class="text-xs text-green-700 font-bold">å ´æ‰€ã‚’ç‰¹å®šã—ã¾ã—ãŸ</p>
                        <p class="text-sm">åœ¨åº«æ•°ã‚’ç¢ºèªãƒ»å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ</p>
                    </div>
                    <a id="kintone-link" href="#" target="_blank" class="bg-green-600 text-white text-sm px-3 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-1">
                        è©³ç´° <span class="material-icons text-sm">open_in_new</span>
                    </a>
                </div>
            </div>

            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ã‚¬ã‚¤ãƒ‰ -->
            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-sm">
                <p class="font-bold text-blue-800 mb-1 flex items-center gap-1">
                    <span class="material-icons text-sm">info</span> åˆ©ç”¨ã‚¬ã‚¤ãƒ‰
                </p>
                <ul class="list-disc list-inside text-gray-600 space-y-1">
                    <li>ç•ªåœ°ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚€ã¨ãƒãƒƒãƒ—ãŒå…‰ã‚Šã¾ã™</li>
                    <li>kintoneä¸Šã®ç•ªåœ°ã€ŒA-01ã€ãªã©ã«å¯¾å¿œ</li>
                    <li><span class="font-bold text-gray-800">ç®¡ç†è€…æ©Ÿèƒ½:</span> ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å®Ÿéš›ã®ç•ªåœ°åã‚’ç™»éŒ²å¯èƒ½</li>
                </ul>
            </div>
        </div>

        <!-- ãƒãƒƒãƒ—è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="bg-white p-2 rounded-xl shadow-lg border border-gray-200 relative">
            <div class="flex justify-between items-center mb-2 px-2">
                <h2 class="font-bold text-gray-700">ãƒ•ãƒ­ã‚¢ãƒãƒƒãƒ—</h2>
                <div class="flex gap-2">
                    <label class="flex items-center gap-1 cursor-pointer select-none">
                        <input type="checkbox" id="edit-mode-toggle" class="form-checkbox h-4 w-4 text-blue-600">
                        <span class="text-xs font-bold text-gray-500">ç•ªåœ°ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</span>
                    </label>
                </div>
            </div>

            <div class="map-container shadow-inner bg-gray-800" id="map-scroll-area">
                <!-- ç”»åƒãŒãªã„å ´åˆã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ -->
                <div id="no-image-placeholder" class="absolute inset-0 flex items-center justify-center text-gray-500">
                    <div class="text-center">
                        <span class="material-icons text-4xl">map</span>
                        <p class="text-xs mt-1">ãƒãƒƒãƒ—ç”»åƒã‚’è¨­å®šã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
                
                <img id="floor-img" src="" class="w-full h-auto block opacity-80" style="min-height: 300px; object-fit: contain;">
                <div id="grid-parent" class="grid-overlay"></div>
            </div>
        </div>

        <!-- ç®¡ç†è€…è¨­å®šã‚¨ãƒªã‚¢ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ -->
        <details class="bg-gray-200 rounded-xl overflow-hidden text-xs">
            <summary class="p-3 font-bold cursor-pointer hover:bg-gray-300 select-none flex justify-between">
                <span>ğŸ”§ ç®¡ç†è€…è¨­å®šï¼ˆãƒãƒƒãƒ—ãƒ»ã‚°ãƒªãƒƒãƒ‰èª¿æ•´ï¼‰</span>
                <span class="material-icons text-sm">expand_more</span>
            </summary>
            <div class="p-4 space-y-3 bg-gray-100 border-t border-gray-300">
                <div>
                    <label class="block mb-1 font-bold">ãƒãƒƒãƒ—ç”»åƒ:</label>
                    <input type="file" id="map-upload" accept="image/*" class="w-full bg-white border p-1 rounded">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block mb-1 font-bold">æ¨ªã®ãƒã‚¹æ•° (X):</label>
                        <input type="number" id="grid-x" value="10" class="w-full p-2 border rounded text-center">
                    </div>
                    <div>
                        <label class="block mb-1 font-bold">ç¸¦ã®ãƒã‚¹æ•° (Y):</label>
                        <input type="number" id="grid-y" value="10" class="w-full p-2 border rounded text-center">
                    </div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button id="save-settings" class="flex-1 bg-gray-700 text-white py-2 rounded font-bold hover:bg-gray-800">è¨­å®šã‚’ä¿å­˜</button>
                    <button id="clear-mapping" class="px-3 bg-red-100 text-red-600 border border-red-200 rounded hover:bg-red-200">ç•ªåœ°å®šç¾©ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>
        </details>
        
        <div class="h-8"></div><!-- Spacer -->
    </main>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼šç•ªåœ°ç·¨é›†ç”¨ -->
    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-5 rounded-xl shadow-2xl w-80">
            <h3 class="font-bold text-lg mb-2 text-gray-800">ç•ªåœ°ã‚’å‰²ã‚Šå½“ã¦</h3>
            <p class="text-xs text-gray-500 mb-4">ã“ã®å ´æ‰€ã«å¯¾å¿œã™ã‚‹QRã‚³ãƒ¼ãƒ‰ã®ç•ªåœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
            <input id="edit-address-input" type="text" class="w-full border-2 border-blue-200 rounded-lg p-2 text-xl font-mono uppercase mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹: A-1">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 font-bold hover:bg-gray-100 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button id="save-mapping-btn" class="px-4 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 shadow">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šã¨å®šæ•° ---
        const STORAGE_KEY = 'dx_stock_config';
        const MAPPING_KEY = 'dx_stock_mapping';
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
        let config = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
            img: '', x: 10, y: 10
        };
        // ç•ªåœ°ãƒãƒƒãƒ”ãƒ³ã‚°: { "cellId": "UserDefinedAddress", ... }
        // ä¾‹: { "5-3": "A-01" }  (ã‚°ãƒªãƒƒãƒ‰ã®x-yåº§æ¨™ã«å¯¾ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®šç¾©ã—ãŸç•ªåœ°å)
        let addressMapping = JSON.parse(localStorage.getItem(MAPPING_KEY)) || {};

        let scanner = null;
        let selectedCellId = null; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§é¸æŠä¸­ã®ã‚»ãƒ«ID

        // DOMè¦ç´ 
        const els = {
            floorImg: document.getElementById('floor-img'),
            gridParent: document.getElementById('grid-parent'),
            targetDisplay: document.getElementById('target-display'),
            searchInput: document.getElementById('search-input'),
            searchBtn: document.getElementById('search-btn'),
            scanTrigger: document.getElementById('scan-trigger'),
            readerContainer: document.getElementById('reader-container'),
            mapUpload: document.getElementById('map-upload'),
            saveSettings: document.getElementById('save-settings'),
            gridX: document.getElementById('grid-x'),
            gridY: document.getElementById('grid-y'),
            editModeToggle: document.getElementById('edit-mode-toggle'),
            editModal: document.getElementById('edit-modal'),
            editAddressInput: document.getElementById('edit-address-input'),
            saveMappingBtn: document.getElementById('save-mapping-btn'),
            resultAction: document.getElementById('result-action'),
            kintoneLink: document.getElementById('kintone-link'),
            clearMappingBtn: document.getElementById('clear-mapping'),
            noImagePlaceholder: document.getElementById('no-image-placeholder')
        };

        // --- åˆæœŸåŒ– ---
        function init() {
            // UIã¸ã®è¨­å®šåæ˜ 
            els.gridX.value = config.x;
            els.gridY.value = config.y;
            if (config.img) {
                els.floorImg.src = config.img;
                els.noImagePlaceholder.style.display = 'none';
            }

            renderMap();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            els.searchBtn.onclick = () => locate(els.searchInput.value);
            els.searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') locate(els.searchInput.value); });
            
            els.scanTrigger.onclick = startScanner;
            els.saveSettings.onclick = saveConfig;
            
            els.editModeToggle.onchange = (e) => {
                document.body.classList.toggle('edit-mode', e.target.checked);
            };

            els.saveMappingBtn.onclick = saveMapping;
            els.clearMappingBtn.onclick = () => {
                if(confirm('ã™ã¹ã¦ã®ç•ªåœ°å‰²ã‚Šå½“ã¦è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    addressMapping = {};
                    localStorage.removeItem(MAPPING_KEY);
                    renderMap();
                }
            };

            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ (kintoneã‹ã‚‰ã®é·ç§»ç”¨)
            checkUrlParams();
        }

        // --- ãƒãƒƒãƒ—æç”» ---
        function renderMap() {
            // ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š
            els.gridParent.style.gridTemplateColumns = `repeat(${config.x}, 1fr)`;
            els.gridParent.style.gridTemplateRows = `repeat(${config.y}, 1fr)`;
            els.gridParent.innerHTML = '';

            const totalCells = config.x * config.y;

            for (let i = 0; i < totalCells; i++) {
                const x = i % config.x;
                const y = Math.floor(i / config.x);
                const cellKey = `${x}-${y}`; // å†…éƒ¨åº§æ¨™ã‚­ãƒ¼
                
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                cell.dataset.key = cellKey;
                
                // ãƒãƒƒãƒ”ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ç•ªåœ°ãŒã‚ã‚Œã°è¡¨ç¤º
                const mappedAddr = getMappedAddress(cellKey);
                if (mappedAddr) {
                    cell.classList.add('mapped');
                    cell.dataset.address = mappedAddr;
                }

                // ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ï¼ˆå¹ãå‡ºã—ï¼‰
                cell.innerHTML = `
                    <div class="info-bubble">
                        <span class="addr-text">${mappedAddr || (numToAlpha(x) + (y+1))}</span>
                    </div>
                `;

                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼šé€šå¸¸æ™‚ã¯å ´æ‰€è¡¨ç¤ºã€ç·¨é›†æ™‚ã¯è¨­å®š
                cell.onclick = () => handleCellClick(cellKey, mappedAddr);
                
                els.gridParent.appendChild(cell);
            }
        }

        // --- åº§æ¨™å¤‰æ›ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function numToAlpha(num) {
            // 0 -> A, 1 -> B ... 26 -> AA (ç°¡æ˜“ç‰ˆ)
            return String.fromCharCode(65 + (num % 26));
        }

        function getMappedAddress(cellKey) {
            // key "5-3" -> returns "A-01" if exists
            return Object.keys(addressMapping).find(key => addressMapping[key] === cellKey) || null; // é€†å¼•ãã§ã¯ãªãé †å¼•ããŒå¿…è¦
            // addressMappingã®æ§‹é€ : { "5-3": "A-01" } (key=cell, val=addr)
            return addressMapping[cellKey];
        }

        // --- ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ ---
        function handleCellClick(cellKey, currentAddr) {
            if (els.editModeToggle.checked) {
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                selectedCellId = cellKey;
                els.editAddressInput.value = currentAddr || "";
                els.editModal.classList.remove('hidden');
                setTimeout(() => els.editAddressInput.focus(), 100);
            } else {
                // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šãã®å ´æ‰€ã®æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆå¿…è¦ã§ã‚ã‚Œã°ï¼‰
                // é€†å¼•ãç”¨ã«ç•ªåœ°ã‚’inputã«å…¥ã‚Œã¦æ¤œç´¢ã™ã‚‹ã‚ˆã†ãªå‹•ä½œã‚‚å¯èƒ½
                if (currentAddr) {
                    els.searchInput.value = currentAddr;
                    locate(currentAddr);
                }
            }
        }

        function saveMapping() {
            const val = els.editAddressInput.value.trim().toUpperCase();
            if (selectedCellId) {
                if (val) {
                    addressMapping[selectedCellId] = val;
                } else {
                    delete addressMapping[selectedCellId]; // ç©ºãªã‚‰å‰Šé™¤
                }
                localStorage.setItem(MAPPING_KEY, JSON.stringify(addressMapping));
                renderMap();
                closeModal();
            }
        }

        function closeModal() {
            els.editModal.classList.add('hidden');
            selectedCellId = null;
        }

        // --- æ¤œç´¢ãƒ»ç‰¹å®šãƒ­ã‚¸ãƒƒã‚¯ (é‡è¦) ---
        function locate(input) {
            if (!input) return;
            
            // 1. å…¥åŠ›å€¤ã®æ­£è¦åŒ– (kintone URLå¯¾å¿œãªã©)
            let rawAddress = input;
            
            // kintoneã®URLãªã©ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã®ç°¡æ˜“æŠ½å‡º
            // ä¾‹: https://subdomain.cybozu.com/k/123/show#...&address=A-01...
            // ã¾ãŸã¯ã€URLå†…ã«ç›´æ¥ç•ªåœ°ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã€inputè‡ªä½“ã‚’ç•ªåœ°ã¨ã¿ãªã™
            try {
                if (input.startsWith('http')) {
                    const url = new URL(input);
                    const params = new URLSearchParams(url.search);
                    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã« 'address' ã‚„ 'loc' ãŒã‚ã‚Œã°æ¡ç”¨
                    if (params.get('address')) rawAddress = params.get('address');
                    else if (params.get('loc')) rawAddress = params.get('loc');
                    // ãƒãƒƒã‚·ãƒ¥ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ (kintoneã¯ãƒãƒƒã‚·ãƒ¥ã‚’ä½¿ã†ã“ã¨ãŒå¤šã„)
                    else if (url.hash.includes('address=')) {
                        const hashParams = new URLSearchParams(url.hash.substring(1)); // #é™¤å»
                        if (hashParams.get('address')) rawAddress = hashParams.get('address');
                    }
                    // URLè‡ªä½“ã«ç•ªåœ°ãŒå«ã¾ã‚Œã¦ã„ãªã‘ã‚Œã°ã€ã©ã†ã—ã‚ˆã†ã‚‚ãªã„ã®ã§URLã‚’æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†ã®ã¯é¿ã‘ã‚‹
                    // ã“ã“ã§ã¯ã€ŒQRã«ã¯ç•ªåœ°æ–‡å­—åˆ—ãŒå…¥ã£ã¦ã„ã‚‹ã€ã¨ã„ã†é‹ç”¨ã‚’å‰æã«ã™ã‚‹
                }
            } catch (e) { console.error("URL Parse Error", e); }

            // æ¤œç´¢ç”¨ã«å¤§æ–‡å­—åŒ–ï¼†ãƒˆãƒªãƒ 
            const targetAddr = rawAddress.trim().toUpperCase();
            
            // UIæ›´æ–°
            els.targetDisplay.innerText = targetAddr;
            els.resultAction.classList.remove('hidden');
            // ãƒ€ãƒŸãƒ¼ã®kintoneãƒªãƒ³ã‚¯ï¼ˆå®Ÿé‹ç”¨ã§ã¯å‹•çš„ã«ç”Ÿæˆå¯èƒ½ï¼‰
            els.kintoneLink.href = `https://kintone.cybozu.co.jp/search?q=${targetAddr}`; 

            // 2. ãƒãƒƒãƒ—ä¸Šã®ãƒãƒƒãƒãƒ³ã‚°
            document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('active'));
            
            let matchedCell = null;

            // A. ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ã‹ã‚‰ã®æ¤œç´¢ (å®Œå…¨ä¸€è‡´å„ªå…ˆ)
            const mappedKey = Object.keys(addressMapping).find(key => addressMapping[key] === targetAddr);
            
            if (mappedKey) {
                matchedCell = document.querySelector(`.grid-cell[data-key="${mappedKey}"]`);
            } 
            // B. ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ã‹ã‚‰ã®æ¤œç´¢ (å‰æ–¹ä¸€è‡´ - æ£šç•ªã®ã¿ã§ãƒ’ãƒƒãƒˆã•ã›ã‚‹å ´åˆãªã©)
            else {
                // ä¾‹: å…¥åŠ›ãŒ "A-01-3æ®µç›®" ã ãŒã€ãƒãƒƒãƒ—ã«ã¯ "A-01" ã—ã‹å®šç¾©ã•ã‚Œã¦ã„ãªã„å ´åˆ
                const partialKey = Object.keys(addressMapping).find(key => targetAddr.startsWith(addressMapping[key]));
                if (partialKey) {
                    matchedCell = document.querySelector(`.grid-cell[data-key="${partialKey}"]`);
                }
            }

            // C. è‡ªå‹•ç”ŸæˆIDã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (å¾“æ¥ã® A1, B2... å½¢å¼)
            // ãƒãƒƒãƒ”ãƒ³ã‚°ãŒãªã„å ´åˆã®äºˆå‚™å‹•ä½œ
            if (!matchedCell) {
                // å…¥åŠ›ã‹ã‚‰ "A1" ã‚„ "W5" ã®ã‚ˆã†ãªåº§æ¨™æˆåˆ†ã‚’å–ã‚Šå‡ºã™
                // æ­£è¦è¡¨ç¾: ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ + æ•°å­—
                const match = targetAddr.match(/^([A-Z]+)([0-9]+)/);
                if (match) {
                    const colStr = match[1]; // "A"
                    const rowNum = parseInt(match[2]); // 1
                    
                    // A -> 0, B -> 1 ... ç°¡æ˜“å¤‰æ›
                    const colIndex = colStr.charCodeAt(0) - 65; 
                    const rowIndex = rowNum - 1;

                    if (colIndex >= 0 && colIndex < config.x && rowIndex >= 0 && rowIndex < config.y) {
                        matchedCell = document.querySelector(`.grid-cell[data-key="${colIndex}-${rowIndex}"]`);
                    }
                }
            }

            // 3. çµæœè¡¨ç¤º
            if (matchedCell) {
                matchedCell.classList.add('active');
                
                // å¹ãå‡ºã—ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
                const bubble = matchedCell.querySelector('.addr-text');
                if (bubble) bubble.innerText = targetAddr; // å…¥åŠ›ã•ã‚ŒãŸè©³ç´°ãªç•ªåœ°ã‚’è¡¨ç¤º

                matchedCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else {
                alert(`ãƒãƒƒãƒ—ä¸Šã«ç•ªåœ°ã€Œ${targetAddr}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ãƒãƒƒãƒ—ä¸Šã®ä½ç½®ã«ã“ã®ç•ªåœ°ã‚’å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„ã€‚`);
            }
        }

        // --- QRã‚¹ã‚­ãƒ£ãƒŠãƒ¼ ---
        function startScanner() {
            if (scanner) return;
            els.readerContainer.classList.remove('hidden');
            
            scanner = new Html5QrcodeScanner("reader", { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            });
            
            scanner.render((decodedText) => {
                stopScanner();
                els.searchInput.value = decodedText;
                locate(decodedText);
            }, (error) => {
                // èª­ã¿å–ã‚Šä¸­ã®ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            });
        }

        function stopScanner() {
            if (scanner) {
                scanner.clear().then(() => {
                    scanner = null;
                    els.readerContainer.classList.add('hidden');
                });
            } else {
                els.readerContainer.classList.add('hidden');
            }
        }

        // --- è¨­å®šä¿å­˜ ---
        function saveConfig() {
            const file = els.mapUpload.files[0];
            const newX = parseInt(els.gridX.value);
            const newY = parseInt(els.gridY.value);

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ã)
            const saveToStorage = (newConfig) => {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(newConfig));
                    config = newConfig; // ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã‚’æ›´æ–°

                    // é‡è¦ãªä¿®æ­£: è¨­å®šä¿å­˜å¾Œã€å³åº§ã«ç”»åƒã‚’åæ˜ ã•ã›ã‚‹
                    if (config.img) {
                        els.floorImg.src = config.img;
                        els.noImagePlaceholder.style.display = 'none';
                    } else {
                        els.floorImg.src = '';
                        els.noImagePlaceholder.style.display = 'flex';
                    }

                    renderMap();
                    alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                } catch (e) {
                    console.error("Storage Error:", e);
                    if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                        alert('ã€ã‚¨ãƒ©ãƒ¼ã€‘ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¦ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\n\nãƒ»ã‚ˆã‚Šè§£åƒåº¦ã®ä½ã„ç”»åƒã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„\nãƒ»ç”»åƒã‚’åœ§ç¸®ã—ã¦ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„');
                    } else {
                        alert('è¨­å®šã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    }
                }
            };

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgData = e.target.result;
                    // ç”»åƒã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ã®ç›®å®‰ï¼ˆBase64æ–‡å­—åˆ—é•·ã§ãŠãŠã‚ˆãåˆ¤æ–­ï¼‰
                    if (imgData.length > 4000000) { // ç´„3-4MB
                        alert('è­¦å‘Š: ç”»åƒã‚µã‚¤ã‚ºãŒå¤§ãã„ãŸã‚ã€ä¿å­˜ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
                    }
                    saveToStorage({ img: imgData, x: newX, y: newY });
                };
                reader.readAsDataURL(file);
            } else {
                // ç”»åƒå¤‰æ›´ãªã—
                saveToStorage({ img: config.img, x: newX, y: newY });
            }
        }

        // --- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‡¦ç† ---
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const addr = params.get('address') || params.get('q');
            if (addr) {
                setTimeout(() => locate(addr), 500); // æç”»å¾…ã¡
            }
        }

        init();
    </script>
</body>
</html>